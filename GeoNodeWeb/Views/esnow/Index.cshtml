
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css" type="text/css">
<script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>

@*<link rel="stylesheet" href="http://test.geoportal.ingeo.kz/geoserver/openlayers3/ol.css" type="text/css">
    <script src="http://test.geoportal.ingeo.kz/geoserver/openlayers3/ol.js"></script>*@

<script src="~/lib/moment.js/moment.js"></script>
<h1>MODIS</h1>

<select id="dates" onchange="ChangeLayerMODIS()" hidden="hidden">
    @foreach (DateTime dateTime in (DateTime[])ViewBag.DateTime)
    {
        <option value="@dateTime">
            @dateTime.ToString("yyyy-MM-dd")
        </option>
    }
</select>
@{
    DateTime[] dates = ViewBag.DateTime;
}

<label>Дата</label>: <label id="DateLabel"></label>
<input id="date" type="range" min="0" value="0" max="@(dates.Count()-1)" step="1">

<label>
    <input type="checkbox" id="layerMODISShow" checked="checked" onchange="ChangeLayers()">
    MODIS
</label>
<input id="layerMODISOpacity" type="range" min="0" max="100" value="80" oninput="ChangeLayers()" />

<label>
    <input type="checkbox" id="layerWMAShow" checked="checked" onchange="ChangeLayers()">
    ВХУ
</label>
<input id="layerWMAOpacity" type="range" min="0" max="100" value="80" oninput="ChangeLayers()" />

<div id="map" class="map"></div>
<script type="text/javascript">
    var geoserver_url = "http://test.geoportal.ingeo.kz/geoserver/",
        geoserver_workspace_name = "modis";

    var url_MODIS = geoserver_url + geoserver_workspace_name + '/wms';
    var Source_MODIS = new ol.source.TileWMS({
        url: url_MODIS,
        params: {
            'FORMAT': 'image/png',
            'VERSION': '1.1.1',
            tiled: true,
            "LAYERS": geoserver_workspace_name + ':Maximum_Snow_Extent_MOD10A2006',
            "exceptions": 'application/vnd.ogc.se_inimage',
            tilesOrigin: 39.1622186743878 + "," + 39.9996233923096
        },
        serverType: 'geoserver'
    });
    var Layer_MODIS = new ol.layer.Tile({
        source: Source_MODIS
    });
    Layer_MODIS.set('name', 'MODIS');
    Layer_MODIS.setOpacity(0.80);

    var url_WMA = geoserver_url + 'geonode' + '/wms';
    var Source_WMA = new ol.source.TileWMS({
        url: url_WMA,
        params: {
            'FORMAT': 'image/png',
            'VERSION': '1.1.1',
            tiled: true,
            "LAYERS": 'geonode:wma_polygon',
            "exceptions": 'application/vnd.ogc.se_inimage',
            tilesOrigin: 39.1622186743878 + "," + 39.9996233923096
        },
        serverType: 'geoserver'
    });
    var Layer_WMA = new ol.layer.Tile({
        source: Source_WMA
    });
    Layer_WMA.set('name', 'WMA');
    Layer_WMA.setOpacity(0.80);

    var map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            }),
            Layer_MODIS,
            Layer_WMA],
        view: new ol.View({
            center: ol.proj.fromLonLat([66.902, 48.714]),
            zoom: 5
        })
    });

    var dates = new Array();
    $('#dates option').each(function () {
        dates.push($(this).val());
    });
    var input = document.getElementById('date'),
        output = document.getElementById('DateLabel');
    input.oninput = function () {
        output.innerHTML = moment(dates[this.value]).format('YYYY-MM-DD');
        ChangeLayerMODIS();
    };
    input.oninput();

    function ChangeLayerMODIS() {
        var Source_MODIS_New = new ol.source.TileWMS({
            url: geoserver_url + geoserver_workspace_name + '/wms?' + 'time=' + /*$('#date').val()*/$('#DateLabel').html() + '&',
            params: {
                'FORMAT': 'image/png',
                'VERSION': '1.1.1',
                tiled: true,
                "LAYERS": geoserver_workspace_name + ':Maximum_Snow_Extent_MOD10A2006',
                "exceptions": 'application/vnd.ogc.se_inimage',
                tilesOrigin: 39.1622186743878 + "," + 39.9996233923096
            },
            serverType: 'geoserver'
        });
        Layer_MODIS.setSource(Source_MODIS_New);
    }

    function ChangeLayers() {
        map.getLayers().forEach(function (layer) {
            if (layer.get('name') == 'MODIS') {
                layer.setVisible(document.getElementById("layerMODISShow").checked);
                layer.setOpacity($('#layerMODISOpacity').val() / 100)
            }
            if (layer.get('name') == 'WMA') {
                layer.setVisible(document.getElementById("layerWMAShow").checked);
                layer.setOpacity($('#layerWMAOpacity').val() / 100)
            }
        })
    }
</script>