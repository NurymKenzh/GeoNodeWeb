
@{
    ViewData["Title"] = "Карта";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css" type="text/css">
<script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>

@*<link rel="stylesheet" href="http://test.geoportal.ingeo.kz/geoserver/openlayers3/ol.css" type="text/css">
    <script src="http://test.geoportal.ingeo.kz/geoserver/openlayers3/ol.js"></script>*@

<script src="~/lib/moment.js/moment.js"></script>
<h1>MODIS</h1>

<select id="dates" onchange="ChangeLayerMODIS()" hidden="hidden">
    @foreach (DateTime dateTime in (DateTime[])ViewBag.DateTime)
    {
        <option value="@dateTime">
            @dateTime.ToString("yyyy-MM-dd")
        </option>
    }
</select>
@{
    DateTime[] dates = ViewBag.DateTime;
}

<label>Дата</label>: <label id="DateLabel"></label>
<input id="date" type="range" min="0" value="0" max="@(dates.Count()-1)" step="1">

<label>
    <input type="checkbox" id="layerBaseShow" checked="checked" onchange="ChangeLayers()">
    Базовый слой
</label>
<input id="layerBaseOpacity" type="range" min="0" max="100" value="100" oninput="ChangeLayers()" />
<select id="layerBaseType" onchange="ChangeLayers()">
    <option value="OSM">OpenStreetMap</option>
    <option value="BingAerialWithLabels">Bing Aerial</option>
    <option value="BingRoadStatic">Bing Road (static)</option>
    <option value="BingRoadDynamic">Bing Road (dynamic)</option>
    <option value="HERENormalDay">HERE Normal Day</option>
    <option value="HERENormalDayTransit">HERE Normal Day Transit</option>
    <option value="HERETerrainDay">HERE Terrain Day</option>
    <option value="HEREHybridDay">HERE Hybrid Day</option>
    <option value="StamenWatercolor">Stamen Watercolor</option>
    <option value="StamenTerrain">Stamen Terrain</option>
    <option value="StamenToner">Stamen Toner</option>
    <option value="ArcGIS">ArcGIS</option>
    <option value="ThunderforestOpenCycleMap">Thunderforest OpenCycleMap</option>
    <option value="ThunderforestTransport">Thunderforest Transport</option>
    <option value="ThunderforestLandscape">Thunderforest Landscape</option>
    <option value="ThunderforestOutdoors">Thunderforest Outdoors</option>
    <option value="ThunderforestTransportDark">Thunderforest Transport Dark</option>
    <option value="ThunderforestSpinalMap">Thunderforest Spinal Map</option>
    <option value="ThunderforestPioneer">Thunderforest Pioneer</option>
    <option value="ThunderforestMobileAtlas">Thunderforest Mobile Atlas</option>
    <option value="ThunderforestNeighbourhood">Thunderforest Neighbourhood</option>
</select>

<label>
    <input type="checkbox" id="layerMODISShow" checked="checked" onchange="ChangeLayers()">
    MODIS
</label>
<input id="layerMODISOpacity" type="range" min="0" max="100" value="80" oninput="ChangeLayers()" />

<label>
    <input type="checkbox" id="layerWMAShow" checked="checked" onchange="ChangeLayers()">
    ВХУ
</label>
<input id="layerWMAOpacity" type="range" min="0" max="100" value="80" oninput="ChangeLayers()" />

<button class="btn btn-primary" onclick="Charts()">Графики</button>

<label id="WMAname"></label>
<input type="hidden" id="featureId" />

<div id="map" class="map"></div>

<script type="text/javascript">
    var geoserver_url = "@ViewBag.GeoServerUrl",
        geoserver_workspace_name = "esnow";

    var HEREappId = 'SLdBasp4s1oq2oUbVGxy';
    var HEREappCode = 'D9-h9iVhjgUB_9eUlFETXA';

    var Source_OSM = new ol.source.OSM();
    var Layer_Base = new ol.layer.Tile({
        source: Source_OSM
    });
    Layer_Base.set('name', 'Base');

    Source_BingAerialWithLabels = new ol.source.BingMaps({
        key: 'AmYNYRGlIrw_kppWvrIhfzY1v046b4Ft5nopz6Av94XDvTTo8xTkHCEaZ_zMwCOJ',
        imagerySet: 'AerialWithLabels',
    });
    Source_BingRoadStatic = new ol.source.BingMaps({
        key: 'AmYNYRGlIrw_kppWvrIhfzY1v046b4Ft5nopz6Av94XDvTTo8xTkHCEaZ_zMwCOJ',
        imagerySet: 'Road',
    });
    Source_BingRoadDynamic = new ol.source.BingMaps({
        key: 'AmYNYRGlIrw_kppWvrIhfzY1v046b4Ft5nopz6Av94XDvTTo8xTkHCEaZ_zMwCOJ',
        imagerySet: 'RoadOnDemand',
    });

    var urlTpl = 'https://{1-4}.{base}.maps.cit.api.here.com' +
        '/{type}/2.1/maptile/newest/{scheme}/{z}/{x}/{y}/256/png' +
        '?app_id={app_id}&app_code={app_code}';
    function HEREcreateUrl(tpl, HERElayerDesc) {
        return tpl
            .replace('{base}', HERElayerDesc.base)
            .replace('{type}', HERElayerDesc.type)
            .replace('{scheme}', HERElayerDesc.scheme)
            .replace('{app_id}', HERElayerDesc.app_id)
            .replace('{app_code}', HERElayerDesc.app_code);
    };

    var HERElayerDescNormalDay = {
        base: 'base',
        type: 'maptile',
        scheme: 'normal.day',
        app_id: HEREappId,
        app_code: HEREappCode
    };
    var Source_HERENormalDay = new ol.source.XYZ({
        url: HEREcreateUrl(urlTpl, HERElayerDescNormalDay),
        attributions: 'Map Tiles &copy; ' + new Date().getFullYear() + ' ' +
            '<a href="http://developer.here.com">HERE</a>'
    });

    var HERElayerDescNormalDayTransit = {
        base: 'base',
        type: 'maptile',
        scheme: 'normal.day.transit',
        app_id: HEREappId,
        app_code: HEREappCode
    };
    var Source_HERENormalDayTransit = new ol.source.XYZ({
        url: HEREcreateUrl(urlTpl, HERElayerDescNormalDayTransit),
        attributions: 'Map Tiles &copy; ' + new Date().getFullYear() + ' ' +
            '<a href="http://developer.here.com">HERE</a>'
    });

    var HERElayerDescTerrainDay = {
        base: 'aerial',
        type: 'maptile',
        scheme: 'terrain.day',
        app_id: HEREappId,
        app_code: HEREappCode
    };
    var Source_HERETerrainDay = new ol.source.XYZ({
        url: HEREcreateUrl(urlTpl, HERElayerDescTerrainDay),
        attributions: 'Map Tiles &copy; ' + new Date().getFullYear() + ' ' +
            '<a href="http://developer.here.com">HERE</a>'
    });

    var HERElayerDescHybridDay = {
        base: 'aerial',
        type: 'maptile',
        scheme: 'hybrid.day',
        app_id: HEREappId,
        app_code: HEREappCode
    };
    var Source_HEREHybridDay = new ol.source.XYZ({
        url: HEREcreateUrl(urlTpl, HERElayerDescHybridDay),
        attributions: 'Map Tiles &copy; ' + new Date().getFullYear() + ' ' + '<a href="http://developer.here.com">HERE</a>'
    });

    var Source_StamenWatercolor = new ol.source.Stamen({
        layer: 'watercolor'
    });

    var Source_StamenTerrain = new ol.source.Stamen({
        layer: 'terrain'
    });

    var Source_StamenToner = new ol.source.Stamen({
        layer: 'toner'
    });

    var Source_ArcGIS = new ol.source.XYZ({
        attributions: 'Tiles © <a href="https://services.arcgisonline.com/ArcGIS/' +
            'rest/services/World_Topo_Map/MapServer">ArcGIS</a>',
        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/' +
            'World_Topo_Map/MapServer/tile/{z}/{y}/{x}'
    });

    var Source_ThunderforestOpenCycleMap = new ol.source.XYZ({
        url: 'https://{a-c}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png' +
            '?apikey=6746f4299ea3479aba8726b09f049c1b'
    });

    var Source_ThunderforestTransport = new ol.source.XYZ({
        url: 'https://{a-c}.tile.thunderforest.com/transport/{z}/{x}/{y}.png' +
            '?apikey=6746f4299ea3479aba8726b09f049c1b'
    });

    var Source_ThunderforestLandscape = new ol.source.XYZ({
        url: 'https://{a-c}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png' +
            '?apikey=6746f4299ea3479aba8726b09f049c1b'
    });

    var Source_ThunderforestOutdoors = new ol.source.XYZ({
        url: 'https://{a-c}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png' +
            '?apikey=6746f4299ea3479aba8726b09f049c1b'
    });

    var Source_ThunderforestTransportDark = new ol.source.XYZ({
        url: 'https://{a-c}.tile.thunderforest.com/transport-dark/{z}/{x}/{y}.png' +
            '?apikey=6746f4299ea3479aba8726b09f049c1b'
    });

    var Source_ThunderforestSpinalMap = new ol.source.XYZ({
        url: 'https://{a-c}.tile.thunderforest.com/spinal-map/{z}/{x}/{y}.png' +
            '?apikey=6746f4299ea3479aba8726b09f049c1b'
    });

    var Source_ThunderforestPioneer = new ol.source.XYZ({
        url: 'https://{a-c}.tile.thunderforest.com/pioneer/{z}/{x}/{y}.png' +
            '?apikey=6746f4299ea3479aba8726b09f049c1b'
    });

    var Source_ThunderforestMobileAtlas = new ol.source.XYZ({
        url: 'https://{a-c}.tile.thunderforest.com/mobile-atlas/{z}/{x}/{y}.png' +
            '?apikey=6746f4299ea3479aba8726b09f049c1b'
    });

    var Source_ThunderforestNeighbourhood = new ol.source.XYZ({
        url: 'https://{a-c}.tile.thunderforest.com/neighbourhood/{z}/{x}/{y}.png' +
            '?apikey=6746f4299ea3479aba8726b09f049c1b'
    });

    var url_MODIS = geoserver_url + geoserver_workspace_name + '/wms';
    var Source_MODIS = new ol.source.TileWMS({
        url: url_MODIS,
        params: {
            'FORMAT': 'image/png',
            'VERSION': '1.1.1',
            tiled: true,
            "LAYERS": geoserver_workspace_name + ':SANMOST_MOD10A2006_MAXIMUM_SNOW_EXTENT',
            "exceptions": 'application/vnd.ogc.se_inimage',
            tilesOrigin: 39.1622186743878 + "," + 39.9996233923096
        },
        serverType: 'geoserver'
    });
    var Layer_MODIS = new ol.layer.Tile({
        source: Source_MODIS
    });
    Layer_MODIS.set('name', 'MODIS');
    Layer_MODIS.setOpacity(0.80);

    var url_WMA = geoserver_url + 'geonode' + '/wms';
    var Source_WMA = new ol.source.TileWMS({
        url: url_WMA,
        params: {
            'FORMAT': 'image/png',
            'VERSION': '1.1.1',
            tiled: true,
            "LAYERS": 'geonode:wma_polygon',
            "exceptions": 'application/vnd.ogc.se_inimage',
            tilesOrigin: 39.1622186743878 + "," + 39.9996233923096
        },
        serverType: 'geoserver'
    });
    var Layer_WMA = new ol.layer.Tile({
        source: Source_WMA
    });
    Layer_WMA.set('name', 'WMA');
    Layer_WMA.setOpacity(0.80);

    var map = new ol.Map({
        target: 'map',
        layers: [
            Layer_Base,
            Layer_MODIS,
            Layer_WMA],
        view: new ol.View({
            center: ol.proj.fromLonLat([66.902, 48.714]),
            zoom: 5
        })
    });

    var dates = new Array();
    $('#dates option').each(function () {
        dates.push($(this).val());
    });
    var input = document.getElementById('date'),
        output = document.getElementById('DateLabel');
    input.oninput = function () {
        output.innerHTML = moment(dates[this.value]).format('YYYY-MM-DD');
        ChangeLayerMODIS();
    };
    input.oninput();

    function ChangeLayerMODIS() {
        var Source_MODIS_New = new ol.source.TileWMS({
            url: geoserver_url + geoserver_workspace_name + '/wms?' + 'time=' + $('#DateLabel').html() + '&',
            params: {
                'FORMAT': 'image/png',
                'VERSION': '1.1.1',
                tiled: true,
                "LAYERS": geoserver_workspace_name + ':SANMOST_MOD10A2006_MAXIMUM_SNOW_EXTENT',
                "exceptions": 'application/vnd.ogc.se_inimage',
                tilesOrigin: 39.1622186743878 + "," + 39.9996233923096
            },
            serverType: 'geoserver'
        });
        Layer_MODIS.setSource(Source_MODIS_New);
    }

    function ChangeLayers() {
        map.getLayers().forEach(function (layer) {
            if (layer.get('name') == 'Base') {
                layer.setVisible(document.getElementById("layerBaseShow").checked);
                layer.setOpacity($('#layerBaseOpacity').val() / 100)
                if ($('#layerBaseType').val() == 'OSM') {
                    layer.setSource(Source_OSM);
                }
                else if ($('#layerBaseType').val() == 'BingAerialWithLabels') {
                    layer.setSource(Source_BingAerialWithLabels);
                }
                else if ($('#layerBaseType').val() == 'BingRoadStatic') {
                    layer.setSource(Source_BingRoadStatic);
                }
                else if ($('#layerBaseType').val() == 'BingRoadDynamic') {
                    layer.setSource(Source_BingRoadDynamic);
                }
                else if ($('#layerBaseType').val() == 'HERENormalDay') {
                    layer.setSource(Source_HERENormalDay);
                }
                else if ($('#layerBaseType').val() == 'HERENormalDayTransit') {
                    layer.setSource(Source_HERENormalDayTransit);
                }
                else if ($('#layerBaseType').val() == 'HERETerrainDay') {
                    layer.setSource(Source_HERETerrainDay);
                }
                else if ($('#layerBaseType').val() == 'HEREHybridDay') {
                    layer.setSource(Source_HEREHybridDay);
                }
                else if ($('#layerBaseType').val() == 'StamenWatercolor') {
                    layer.setSource(Source_StamenWatercolor);
                }
                else if ($('#layerBaseType').val() == 'StamenTerrain') {
                    layer.setSource(Source_StamenTerrain);
                }
                else if ($('#layerBaseType').val() == 'StamenToner') {
                    layer.setSource(Source_StamenToner);
                }
                else if ($('#layerBaseType').val() == 'ArcGIS') {
                    layer.setSource(Source_ArcGIS);
                }
                else if ($('#layerBaseType').val() == 'ThunderforestOpenCycleMap') {
                    layer.setSource(Source_ThunderforestOpenCycleMap);
                }
                else if ($('#layerBaseType').val() == 'ThunderforestTransport') {
                    layer.setSource(Source_ThunderforestTransport);
                }
                else if ($('#layerBaseType').val() == 'ThunderforestLandscape') {
                    layer.setSource(Source_ThunderforestLandscape);
                }
                else if ($('#layerBaseType').val() == 'ThunderforestOutdoors') {
                    layer.setSource(Source_ThunderforestOutdoors);
                }
                else if ($('#layerBaseType').val() == 'ThunderforestTransportDark') {
                    layer.setSource(Source_ThunderforestTransportDark);
                }
                else if ($('#layerBaseType').val() == 'ThunderforestSpinalMap') {
                    layer.setSource(Source_ThunderforestSpinalMap);
                }
                else if ($('#layerBaseType').val() == 'ThunderforestPioneer') {
                    layer.setSource(Source_ThunderforestPioneer);
                }
                else if ($('#layerBaseType').val() == 'ThunderforestMobileAtlas') {
                    layer.setSource(Source_ThunderforestMobileAtlas);
                }
                else if ($('#layerBaseType').val() == 'ThunderforestNeighbourhood') {
                    layer.setSource(Source_ThunderforestNeighbourhood);
                }
            }
            if (layer.get('name') == 'MODIS') {
                layer.setVisible(document.getElementById("layerMODISShow").checked);
                layer.setOpacity($('#layerMODISOpacity').val() / 100)
            }
            if (layer.get('name') == 'WMA') {
                layer.setVisible(document.getElementById("layerWMAShow").checked);
                layer.setOpacity($('#layerWMAOpacity').val() / 100)
            }
        })
    }

    map.on('singleclick', function (evt) {
        var viewResolution = (map.getView().getResolution());
        var url = Layer_WMA.getSource().getGetFeatureInfoUrl(
            evt.coordinate, viewResolution, 'EPSG:3857',
            {
                'INFO_FORMAT': 'text/javascript'
            });
        if (url) {
            var parser = new ol.format.GeoJSON();
            $.ajax({
                jsonp: false,
                jsonpCallback: 'getJson',
                type: 'GET',
                url: url + "&format_options=callback:getJson",
                async: false,
                dataType: 'jsonp',
                error: function (xhr, status, error) {
                    console.log('error');
                    $('#featureId').val(-1);
                },
            }).then(function (response) {
                featureId = -1;
                var result = parser.readFeatures(response);
                if (result.length > 0) {
                    $('#featureId').val(result[0].get('Id'));
                    $('#WMAname').text(result[0].get('NameWMB_Ru'));
                }
            });
        }
    });

    function Charts() {
        if ($('#featureId').val() > -1) {
            var urlC = '@Url.Action("Charts", "esnow")';
            var urlC = '/esnow/Charts?Id=' + $('#featureId').val();
            var win = window.open(urlC, '_blank');
            win.focus();
        }
    };
</script>