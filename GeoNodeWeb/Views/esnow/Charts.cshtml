
@{
    ViewData["Title"] = "Charts";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/lib/сhart.js/dist/Chart.css" rel="stylesheet" />
<script src="~/lib/сhart.js/dist/Chart.js"></script>
<script src="~/lib/moment.js/moment.js"></script>

<h1>Графики</h1>

@*<label>@ViewBag.WMAName</label>*@

<input id="id" value="@ViewBag.Id" type="hidden"/>

<canvas width="704" height="352" class="chartjs-render-monitor" id="canvas" style="width: 704px; height: 352px; display: block;"></canvas>

<script>
    var colors = [
        {
            type: '0',
            color: '#000000',
            label: 'Потерянные данные'
        },
        {
            type: '1',
            color: '#FFFF73',
            label: 'Нет решения'
        },
        {
            type: '11',
            color: '#730000',
            label: 'Ночь'
        },
        {
            type: '25',
            color: '#FFFFFF',
            label: 'Нет снега'
        },
        {
            type: '37',
            color: '#005CE6',
            label: 'Озеро'
        },
        {
            type: '39',
            color: '#0000FF',
            label: 'Море'
        },
        {
            type: '50',
            color: '#ff73de',
            label: 'Облако'
        },
        {
            type: '100',
            color: '#7ab6f5',
            label: 'Лед'
        },
        {
            type: '200',
            color: '#bee8ff',
            label: 'Снег'
        },
        {
            type: '254',
            color: '#FF0000',
            label: 'Детектор насыщен'
        },
        {
            type: '255',
            color: '#FFF000',
            label: 'Заполнено'
        }
    ]

    function ChartWMA() {
        $.ajax({
            url: '@Url.Action("GetWMAInfo")',
            data: {
                Id: @ViewBag.Id,
            },
            type: 'POST',
            success: function (data) {
                console.log('OK');

                var barChartData = {
                    labels: [],
                    datasets: []
                };

                barChartData.labels = [];
                barChartData.datasets = [];
                console.log(data.rasterstats[0].snowData);
                for (i = 0; i < data.rasterstats.length; i++) {
                    barChartData.labels.push(moment(data.rasterstats[i].date).format('YYYY-MM-DD'));
                    for (j = 0; j < data.rasterstats[i].snowData.length; j++) {
                        var exist = false;
                        for (k = 0; k < barChartData.datasets.length; k++) {
                            if (barChartData.datasets[k].snowtype == data.rasterstats[i].snowData[j].dataType) {
                                exist = true;
                                barChartData.datasets[k].data.push(data.rasterstats[i].snowData[j].area);
                            }
                        }
                        if (!exist) {
                            var backgroundColor = '#000000',
                                label = '';
                            for (k = 0; k < colors.length; k++) {
                                if (colors[k].type == data.rasterstats[i].snowData[j].dataType) {
                                    backgroundColor = colors[k].color;
                                    label = colors[k].label;
                                    break;
                                }
                            }
                            barChartData.datasets.push({
                                label: label,
                                snowtype: data.rasterstats[i].snowData[j].dataType,
                                backgroundColor: backgroundColor,
                                borderColor: '#000000',
                                borderWidth: 1,
                                data: [data.rasterstats[i].snowData[j].area]
                            });
                        }
                    }
                }

                var ctx = document.getElementById('canvas').getContext('2d');
                var Bar1 = new Chart(ctx, {
                    type: 'bar',
                    data: barChartData,
                    options: {
                        title: {
                            display: true,
                            text: data.wmaname
                        },
                        tooltips: {
                            mode: 'index',
                            intersect: false
                        },
                        responsive: true,
                        scales: {
                            xAxes: [{
                                stacked: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Дата'
                                }
                            }],
                            yAxes: [{
                                stacked: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Площадь, м²'
                                }
                            }]
                        }
                    }
                });

            },
            error: function () {
                console.log('Error');
            }
        });
    };

    $(document).ready(function () {
        ChartWMA();
    });
</script>